# iptables

linux kernel Netfilter 在用户空间上的接口，它允许用户设置系统防火墙规则
1. 打开和关闭端口
2. 阻止或允许测定的ip地址

* **建议**：<br>
    为了安全起见，只保留需要的ip和port；其余的端口都应该关闭 

## 1. 过滤策略

  1. Deny everything by default policy
    
        这个策略默认是拒绝(相当于是白名单)，当一个ip包进来后，该策略依次检查每个规则，如果遇到一个规则符合就接受这个包<br>
  
  2. Accept everything by default policy
        
        这个策略默认是接受(相当于是黑名单)，当一个ip包进来后，该策略依次检查每个规则，如果遇到一个规则符合就拒绝这个包

   * 两个策略的优缺点, 所以每种策略都要很小心的配置
  
        白名单：是比较可控，非法用户钻空子的可能性相对较小<br>
        黑名单：是可能会把一些合法的请求过滤掉

## 2. 过滤都能保护那些

  * 源地址欺骗
  * 提供端口被扫描的有用信息
  * 用来确定unix系统的错误的广播包
  * 网络映射
  * 一些 拒绝服务 的攻击
  * 源路由的包
  * 一些形式的 fragmenttation bombs
  * 影响远程站点的本地错误
  * 访问私有的局域网服务

## 3. filter Table 的特性

  * Source and destination port lists
  * Access to the TCP state flag, i.e. SYN, ACK, RST, PSH, URG, FIN
  * Access to the TCP options field
  * Connection-state maintenance for TCP, UDP, and ICMP exchanges
    有状态的防火墙会记录已经建立连接的状态，从而绕过防火墙规则
  * Access to the IP header field
  * Access to the MAC source address

  1. TCP SYN flood 攻击
   
      正常的 client-server 建立连接时的三次握手的流程应该是
      
      <code>
      1). client: -> SYN -> server<br>
      2). server: -> SYN/ACK -> client<br>
      3). client: -> ACK -> server <br>
      </code>

      攻击的过程就是:

      client不在发送 3). 步骤的响应，使得server一直处在等待的过程，server维护这个状态是要消耗资源的；<br>
      与此通知，client发起很多个这样的连接请求。从而耗尽server的资源，达到denail-of-service的目的

  2. ping flood 攻击
     
     <code>
     1). 因为ping 是一个 echo 类型的 request，<br>
     2). 首先攻击者会把源地址伪装成受害者的地址，<br>
     3). 然后广播发送ping请求到很多很多机器，这些机器收到请求后就会做出响应，他们获取到源地址是受害者的地址<br>
     4). 于是，受害者会收到海量的包，从而达到 denail-of-service的目的
     </code>

## 4. iptables 的语法
  * iptables --flush
  * iptables -A INPUT -i lo -j ACCEPT
    > 这句就是所有到loopback接口的包都接受
  * iptables -A OUTPUT -o lo -j ACCEPT
    > 这句就是所有从loopback发出的包都接受
  * iptables --policy INPUT DROP
    > 这句就是对收到的包采取默认deny的策略
  * iptables --policy OUTPUT DROP
  * iptables --policy FORWARD DROP
  
  * 参数说明
    > -A: append <br>
    > -I: insert <br>
    
    > INPUT: INPUT chain, that packets coming into the interface <br>
    > OUTPUT: OUTPUT chain, that packets sending from the interface <br>
    
    > -i: input interface <br>
    > -o: output interface<br>
    > lo: 是loopback interface <br>

    > p: protocol, tcp/udp
    
    > -j: the target<br>
        > ACCEPT: 接受这些包 <br>
        > DROP: 丢弃这些包(悄悄的) <br>
        > REKECT: 返回icmp-port-unreachable 错误<br>
    
  *  如果我们不想别人连接ssh的22号端口，<br>
  我们应该对端口采取DROP的策略，这样攻击者就不会收到任何信息，这样攻击者就不会知道这个端口是打开的还是关闭的<br>
  如果我们返回ICMP-port-unreachable错误，就会提供给攻击者信息，从而知道我们的端口已经启用了。


## 5. example: 丢弃 SSH 请求
  
<code>
    SERVER_IP = 192.168.3.21<br>
    iptables -I INPUT -i eth0 -p tcp -s 0/0 -d $SERVER_IP --dport 22 -j DROP
<code>