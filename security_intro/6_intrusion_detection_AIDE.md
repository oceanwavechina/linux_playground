# Intrusion Detection (AIDE)

[How to Install and Configure AIDE on Ubuntu Linux](https://blog.rapid7.com/2017/06/30/how-to-install-and-configure-aide-on-ubuntu-linux/)

因为linux大部分的配置都是在text类型的文本中的，比如
* User ---  /etc/passwd
* Password ---  /etc/shadow
* Authetication ---  /etc/pad.d/*

AIDE(Adevanced Intrusion Detection Environment,高级入侵检测环境)是个入侵检测工具，基于对文本完整的性检查。<br>
AIDE数据库能够保存文档的各种属性，包括：权限(permission)、索引节点序号(inode number)、所属用户(user)、所属用户组(group)、文档大小、最后修改时间(mtime)、创建时间(ctime)、最后访问时间(atime)、增加的大小连同连接数。<br>
当有人在你的文件系统做了一些改动事，AIDE会同之前数据库存储的信息做比较，并汇报改动<br>
AIDE还能够使用下列算法：sha1、md5、rmd160、tiger，以密文形式建立每个文档的校验码或散列号。

（因为默认的扫描的配置文件会比较多，所以在实际应用中需要修改）

## 1. AIDE - 安装
---------------------------------------

<code>
    sudo apt-get install aide<br>
    aide -v
</code>

  > liuyanan@debian:~$ aide -v<br>
  > Aide 0.16a2-19-g16ed855<br>
  > <br>
  > Compiled with the following options:<br>
  > <br>
  > WITH_MMAP<br>
  > WITH_POSIX_ACL<br>
  > WITH_SELINUX<br>
  > WITH_XATTR<br>
  > WITH_E2FSATTRS<br>
  > WITH_LSTAT64<br>
  > WITH_READDIR64<br>
  > WITH_ZLIB<br>
  > WITH_MHASH<br>
  > WITH_AUDIT<br>
  > CONFIG_FILE = "/dev/null"<br>

更新AIDE的配置

<code>$ sudo update-aide.conf</code>


## 2. AIDE - 配置
---------------------------------------

* 1). 配置目录
  
  配置文件: <code> /etc/aide </code>
  数据库文件: <code> /var/lib/aide/</code>

* 2). 生成数据库
  
  > 新建立的服务器上要新创建一个新的数据库，使用下边的命令：

  <code>
  sudo aideinit
  </code>

  > Running aide --init... <br>
  > AIDE 0.16a2-19-g16ed855 initialized AIDE database at /var/lib/aide/aide.db.new <br>
  > Start timestamp: 2019-02-06 14:47:54 +0800 <br>
  > Verbose level: 6 <br>
  >  <br>
  > Number of entries:	205727 <br>
  >  <br>
  > --------------------------------------------------- <br>
  > The attributes of the (uncompressed) database(s): <br>
  > --------------------------------------------------- <br>
  >  <br>
  > /var/lib/aide/aide.db.new <br>
  >   RMD160   : UYW+UtNPbX0OMn0blMIxqJaEqw8= <br>
  >   TIGER    : DugAcwHe+648UdxyNeEQLEFCT9Q+ETos <br>
  >   SHA256   : WMZPuF0uGpRejYWnWF8NuOS/eLbRdWEf <br>
  >              RhNMzsHvf6I= <br>
  >   SHA512   : hHBsr5Xs6UG/ljs0+ltW+r5uR63anNmm <br>
  >              TBsIYqNBNZOe4rQ8Kn2uH88OWvC0oRxa <br>
  >              iI2IiFsBg1NKAc6aWJQj2Q== <br>
  >   CRC32    : NSZhvw== <br>
  >   HAVAL    : qT39wrnJ/G7TfI7MiG0Zzcz3D0yP2wsP <br>
  >              o+Okw8eDt5k= <br>
  >   GOST     : JiNeu2adWxNbocOHvuE/JxK0y4U9lE+Z <br>
  >              DNqdSHOmu9A= <br>
  >  <br>
  >  <br>
  > End timestamp: 2019-02-06 14:53:42 +0800 (run time: 5m 48s) <br>

* 3). 安装新生成的数据库

  <code>sudo cp /var/lib/aide/aide.db.new /var/lib/aide/aide.db</code>

* 4). 生成配置文件

  <code>sudo update-aide.conf</code>

* 5). 安装配置文件

  <code>cp /var/lib/aide/aide.conf.autogenerated /etc/aide/aide.conf</code>


## 2. AIDE - 检查
---------------------------------------

新添加用户会修改 <code>/etc/passwd</code> 文件，我们新添加一个用户

  <code>sudo useradd intruder</code>

检查

<code>
  aide -c /etc/aide/aide.conf --check
</code>

> liuyanan@debian:~$ sudo aide -c /etc/aide/aide.conf --check<br>
> AIDE 0.16a2-19-g16ed855 found differences between database and filesystem!!<br>
> Start timestamp: 2019-02-06 19:24:17 +0800<br>
> Verbose level: 6<br>
> <br>
> Summary:<br>
>   Total number of entries:	205737<br>
>   Added entries:		10<br>
>   Removed entries:		0<br>
>   Changed entries:		26<br>
> <br>
> ---------------------------------------------------<br>
> Added entries:<br>
> ---------------------------------------------------<br>
> <br>
> f++++++++++++++++: /run/systemd/sessions/26<br>
> F++++++++++++++++: /run/systemd/sessions/26.ref<br>
> f++++++++++++++++: /run/systemd/system/session-26.scope<br>
> d++++++++++++++++: /run/systemd/system/session-26.scope.d<br>
> f++++++++++++++++: /run/systemd/system/session-26.scope.d/50-After-systemd-logind\x2eservice.conf<br>
> f++++++++++++++++: /run/systemd/system/session-26.scope.d/50-After-systemd-user-sessions\x2eservice.conf<br>
> f++++++++++++++++: /run/systemd/system/session-26.scope.d/50-Description.conf<br>
> f++++++++++++++++: /run/systemd/system/session-26.scope.d/50-SendSIGHUP.conf<br>
> f++++++++++++++++: /run/systemd/system/session-26.scope.d/50-Slice.conf<br>
> f++++++++++++++++: /var/lib/aide/aide.db<br>
> <br>
> ---------------------------------------------------<br>
> Changed entries:<br>
> ---------------------------------------------------<br>
> <br>
> f >b... mc..C.. .: /etc/aide/aide.conf<br>
> f >.... mci.C.. .: /etc/group<br>
> f >.... mc..C.. .: /etc/group-<br>
> f >.... mci.C.. .: /etc/gshadow<br>
> f >.... mc..C.. .: /etc/gshadow-<br>
> f >.... mci.C.. .: /etc/passwd<br>
> f >.... mc..C.. .: /etc/passwd-<br>
> f >.... mci.C.. .: /etc/shadow<br>
> f =.... mc..... .: /etc/shadow-<br>
> f >.... mci.C.. .: /etc/subgid<br>
> f >.... mc..C.. .: /etc/subgid-<br>
> f >.... mci.C.. .: /etc/subuid<br>
> f >.... mc..C.. .: /etc/subuid-<br>
> d =.... mc.. .. .: /home/liuyanan<br>
> f >.... mc..C.. .: /home/liuyanan/.viminfo<br>
> d =.... mc.. .. .: /root<br>
> f >.... mci.C.. .: /root/.viminfo<br>
> f =.... mc..C..  : /run/log/journal/005688aa000140e5a0d557e0e7cae587/system.journal<br>
> d >.... mc.. ..  : /run/systemd/sessions<br>
> d >.... mc.n ..  : /run/systemd/system<br>
> d =.... mc.. ..  : /run/systemd/users<br>
> f >.... mci.C..  : /run/systemd/users/1000<br>
> f =.... mc..... .: /var/lib/monit/state<br>
> f >.... mc..C.. .: /var/lib/sudo/ts/liuyanan<br>
> f >b... mc..C.. .: /var/log/audit/audit.log<br>
> f >.... mc..C.. .: /var/log/faillog<br>
> <br>
> \---------------------------------------------------<br>
> Detailed information about changes:<br>
> \---------------------------------------------------<br>
> <br>
> File: /etc/passwd<br>
>   Size     : 2179                             | 2224<br>
>   Mtime    : 2019-02-06 14:14:41 +0800        | 2019-02-06 19:23:41 +0800<br>
>   Ctime    : 2019-02-06 14:14:41 +0800        | 2019-02-06 19:23:41 +0800<br>
>   Inode    : 186890                           | 186730<br>
>   RMD160   : VrSn24LfoVBF5rKrACJOHPaQg9c=     | 0MMtONgOoscjTVitEm83PxT9iFM=<br>
>   TIGER    : qbbhwW4aXJY68C27bQLvg6UhyqEbIrkU | tgYcefgtcejPcSvhmQkxQq/w/WVj8OFe<br>
>   SHA256   : cl/0OZBw420287r4ETJNcWhr/laSoxMt | A/qoGgbHCkz53tPX20MmLgrI3G0C7sFN<br>
>              LPWhI50qb/s=                     | 9Tolh+gEkS0=<br>
>   SHA512   : y8SjlaWnaN89NqkFfLNFtaaBgYBPOkdp | bwvSEn8LHG7MXCtnqGSx7FXLIPZtRHWw<br>
>              d3DUlSpavNSJ9X2bjNOK/OliFD4Vt7QP | VOcuI8NWCcaET4fS8qTtjMTUy6fejYh/<br>
>              6mlnIvAqWcxZYvuHFxJF2w==         | zfr+UuerUn4R1I6iie5ZOw==<br>
>   CRC32    : aaSF4A==                         | nisQQA==<br>
>   HAVAL    : a+yD5jMsVbJdmuMDqSmmrA2iqUIiO6wr | ZX9GrLznjSDob1uQmC4MCqIMhFog+nEY<br>
>              NzRc1qNs7WE=                     | YI4VV9hrsLU=<br>
>   GOST     : 2nczv2qBb2NaWkr7TFemGU5/qL/2L9/N | i5iIxxFE3c9WPEdSHeCvjZsqZgXyQgtA<br>
>              w4+H9iTQg8o=                     | g6qI+BFn4+M=<br>

## 3. AIDE - 更新

每次check完成之后，如果有变动的，处理完后需要用最新的数据库覆盖之前的，不然每次都会报警

<code>
  aide -c /etc/aide/aide.conf --update
</code>

## 4. AIDE - 定时检查

因为AIDE不是实时检查文件修改的，所以我们可以配合cron来定时检查并更新，如果有变化的话，发送报警邮件
